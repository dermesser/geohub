<html>
    <head>
        <link rel="stylesheet" href="thirdparty/leaflet.css" />
        <link rel="stylesheet" href="style.css" />
        <title>GeoHub: LiveMap</title>
    </head>
    <body>
    <script src="thirdparty/leaflet.js"></script>
    <script src="shared.js"></script>

    <span id="livemapTitle">GeoHub LiveMap</span>
    <span id="inputFields">
        Client: <input type="text" value="" id="inputClient" />
        Secret: <input type="text" value="" id="inputSecret" />
        <input type="button" value="Go!" id="inputGoButton" onclick="buttonGoClicked()" />
    </span>
    <span id="infoFields" class="timeChanged">
        Last Update: <span id="outputLastUpdate"> </span>
    </span>

    <div id="mapid"> </div>

    <script>
    // Set up map.
    const initial = [50, 10];
    var mapZoomed = false;
    var mymap = L.map('mapid').setView(initial, 5);

    var accessToken = 'pk.eyJ1IjoiZGVybWVzc2VyIiwiYSI6ImNraTdwZmUxZTE2OGgydW1oYTU5eW9qYm4ifQ.f9OxY_U78h6iefp-jN9-9w';
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: accessToken,
    }).addTo(mymap);

    var urlParams = new URLSearchParams(window.location.search);
    var url = new URL(window.location);
    var allMarkers = [];

    // Set the current location, called on every new point. Updates the marker and adds
    // a new point (former position).
    var current_marker = L.marker([0,0]).addTo(mymap);
    const circleProps = {color: 'blue', fillcColor: 'blue', fillOpacity: 0.5, radius: 3}
    function setCurrentLocation(lat, lng) {
        var oldCoord = current_marker.getLatLng();
        current_marker.setLatLng(L.latLng(lat, lng));
        // Show last locations as blue points.
        var circle = L.circle([oldCoord.lat, oldCoord.lng], circleProps);
        circle.addTo(mymap);
        allMarkers.push(circle);
    }

    // Remove all points from the map (except for the "current position" marker).
    function clearAllMarkers() {
        for (var i = 0; i < allMarkers.length; i++) {
            allMarkers[i].remove();
        }
    }

    // New points are available. Display them on the map and update the marker.
    function xhrcallback(xhr) {
        console.log('xhrcallback called.', xhr.readyState, xhr.status);
        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status == 200) {
            const response = xhr.response;
            console.log("Client update for", response.client);
            if (response.client != getClient()) {
                console.log("Received outdated client update.");
                return;
            }
            if (response.client == getClient() && response.geo) {
                const features = response['geo']['features'];
                if (features.length == 0) {
                    return;
                }
                const lastfeature = features[0];
                console.log(`xhrcallback: ${features.length} elements received.`);
                // Backfill old circles. This happens when called from a
                // backfill() triggered request to `/last` or when a client sent
                // several points at once.
                if (features.length > 0) {
                    for (i = 1; i < features.length; i++) {
                        var coords = features[i]['geometry']['coordinates'];
                        var circle = L.circle([coords[1], coords[0]], circleProps);
                        circle.addTo(mymap);
                        allMarkers.push(circle);
                    }
                }

                var coords = lastfeature['geometry']['coordinates'];

                console.log('Received update:', coords, 'last:', response);
                setCurrentLocation(coords[1], coords[0]);
                // 13 is a good default zoom for an updated point.
                mymap.setView([coords[1], coords[0]], mapZoomed ? mymap.getZoom() : 13);
                mapZoomed = true;

                updateUI(lastfeature.properties.time);
            }

            // Install next XHR.
            waitforupdate();
        } else {
            return;
        }
    };


    // Fetch the most recent point for this client and display them.
    function backfill(args) {
        var xhr = new XMLHttpRequest();
        var client = getClient();
        var secret = getSecret();
        if (!client) {
            return;
        }
        var url = `../../geo/${client}/retrieve/last?secret=${secret}&limit=256`;
        console.log('Requesting URL (backfill) ' + url);
        xhr.responseType = 'json';
        xhr.open('GET', url, true);
        xhr.onreadystatechange = function() { xhrcallback(xhr); };
        xhr.send();
    }

    var lastXHR = null;
    // Ask for updates. This request will hang until timeout is reached or
    // an update arrives.
    function waitforupdate() {
        var xhr = new XMLHttpRequest();
        var client = getClient();
        var secret = getSecret();
        if (!client) {
            return;
        }
        var secretparam = secret == null ? '' : `secret=${secret}`;
        var url = `../../geo/${client}/retrieve/live?${secretparam}&timeout=30`;
        console.log('Requesting URL ' + url);
        xhr.responseType = 'json';
        xhr.open('GET', url, true);
        xhr.onreadystatechange = function() { xhrcallback(xhr) };
        xhr.send();
        lastXHR = xhr;
    }

    function updateUI(time) {
        var timefield = document.getElementById('outputLastUpdate');
        var infofields = document.getElementById('infoFields');
        // This dance restarts the green "update" animation.
        infofields.style.animation = 'none';
        infofields.offsetHeight;
        timefield.textContent = Date(time).toLocaleString().replace(/\([\w\s]+\)/,'');
        infofields.style.animation = null;
    }
    // "Go!" was clicked - clear markers and fetch data for new source.
    function buttonGoClicked() {
        clearAllMarkers();
        if (lastXHR) {
            lastXHR.abort();
        }
        updateURL(getClient(), getSecret());
        // Accelerate display.
        backfill();
    }

    getClient();
    getSecret();
    // Once data is backfilled, we wait for the update.
    backfill();

    </script>

    </body>
</html>
